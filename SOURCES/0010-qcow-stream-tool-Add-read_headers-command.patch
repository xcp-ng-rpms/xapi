From 2f99e50858d324de5c1f5000ff81be9b0f3477f0 Mon Sep 17 00:00:00 2001
From: Andrii Sultanov <andriy.sultanov@vates.tech>
Date: Tue, 18 Nov 2025 08:35:44 +0000
Subject: [PATCH] qcow-stream-tool: Add read_headers command

It returns info on the allocated clusters in a JSON.

Signed-off-by: Andrii Sultanov <andriy.sultanov@vates.tech>
---
 ocaml/qcow-stream-tool/dune                |  4 ++
 ocaml/qcow-stream-tool/qcow_stream_tool.ml | 69 +++++++++++++++++++---
 2 files changed, 66 insertions(+), 7 deletions(-)

diff --git a/ocaml/qcow-stream-tool/dune b/ocaml/qcow-stream-tool/dune
index 4daf3469d..436dd5868 100644
--- a/ocaml/qcow-stream-tool/dune
+++ b/ocaml/qcow-stream-tool/dune
@@ -7,5 +7,9 @@
     qcow-stream
     cmdliner
     unix
+    lwt.unix
+    lwt
+    qcow-types
+    yojson
   )
 )
diff --git a/ocaml/qcow-stream-tool/qcow_stream_tool.ml b/ocaml/qcow-stream-tool/qcow_stream_tool.ml
index 7158867c2..0119a5987 100644
--- a/ocaml/qcow-stream-tool/qcow_stream_tool.ml
+++ b/ocaml/qcow-stream-tool/qcow_stream_tool.ml
@@ -1,11 +1,53 @@
+open Cmdliner
+
 module Impl = struct
   let stream_decode output =
     Qcow_stream.stream_decode Unix.stdin output ;
     `Ok ()
+
+  let read_headers qcow_path =
+    let open Lwt.Syntax in
+    let t =
+      let* fd = Lwt_unix.openfile qcow_path [Unix.O_RDONLY] 0 in
+      let* virtual_size, cluster_bits, _, data_cluster_map =
+        Qcow_stream.start_stream_decode fd
+      in
+      let clusters = Qcow_types.Cluster.Map.bindings data_cluster_map in
+      let clusters =
+        List.map
+          (fun (_, virt_address) ->
+            let ( |> ) = Int64.shift_right_logical in
+            let address =
+              Int64.to_int (virt_address |> Int32.to_int cluster_bits)
+            in
+            `Int address
+          )
+          clusters
+      in
+      let json =
+        `Assoc
+          [
+            ("virtual_size", `Int (Int64.to_int virtual_size))
+          ; ("cluster_bits", `Int (Int32.to_int cluster_bits))
+          ; ("data_clusters", `List clusters)
+          ]
+      in
+      let json_string = Yojson.to_string json in
+      let* () = Lwt_io.printf "%s" json_string in
+      let* () = Lwt_io.flush Lwt_io.stdout in
+      Lwt.return_unit
+    in
+    Lwt_main.run t ; `Ok ()
 end
 
 module Cli = struct
-  open Cmdliner
+  let output default =
+    let doc = Printf.sprintf "Path to the output file." in
+    Arg.(value & pos 0 string default & info [] ~doc)
+
+  let input =
+    let doc = Printf.sprintf "Path to the input file." in
+    Arg.(required & pos 0 (some string) None & info [] ~doc)
 
   let stream_decode_cmd =
     let doc = "decode qcow2 formatted data from stdin and write a raw image" in
@@ -15,15 +57,28 @@ module Cli = struct
       ; `P "Decode qcow2 formatted data from stdin and write to a raw file."
       ]
     in
-    let output default =
-      let doc = Printf.sprintf "Path to the output file." in
-      Arg.(value & pos 0 string default & info [] ~doc)
-    in
     Cmd.v
       (Cmd.info "stream_decode" ~doc ~man)
       Term.(ret (const Impl.stream_decode $ output "test.raw"))
 
-  let main () = Cmd.eval stream_decode_cmd
+  let read_headers_cmd =
+    let doc =
+      "Determine allocated clusters by parsing qcow2 file at the provided \
+       path. Returns JSON like the following: {'virtual_size': X, \
+       'cluster_bits': Y, 'data_clusters': [1,2,3]}"
+    in
+    let man = [`S "DESCRIPTION"; `P doc] in
+    Cmd.v
+      (Cmd.info "read_headers" ~doc ~man)
+      Term.(ret (const Impl.read_headers $ input))
+
+  let cmds = [stream_decode_cmd; read_headers_cmd]
 end
 
-let () = exit (Cli.main ())
+let info =
+  let doc = "minimal CLI for qcow-stream" in
+  Cmd.info "qcow-stream-tool" ~version:"1.0.0" ~doc
+
+let () =
+  let cmd = Cmd.group info Cli.cmds in
+  exit (Cmd.eval cmd)
