commit 859afb34f
Author: BenjiReis <benjamin.reis@vates.fr>
Date:   Tue Jan 12 13:52:42 2021 +0100

    Support IPv6 in vncproxy

    Signed-off-by: BenjiReis <benjamin.reis@vates.fr>

diff --git a/ocaml/vncproxy/vncproxy.ml b/ocaml/vncproxy/vncproxy.ml
index 46e77b18d..488c78975 100644
--- a/ocaml/vncproxy/vncproxy.ml
+++ b/ocaml/vncproxy/vncproxy.ml
@@ -35,8 +35,10 @@ let _ =
     (fun x -> Printf.fprintf stderr "Ignoring: %s\n" x)
     "Proxy VNC traffic" ;
   if !vm = "" then failwith "Must supply a VM uuid or name-label" ;
-  let sockaddr = Unix.ADDR_INET (Unix.inet_addr_of_string !ip, 0) in
-  let sock = Unix.socket Unix.PF_INET Unix.SOCK_STREAM 0 in
+  let unwrapped_ip = Scanf.ksscanf !ip (fun _ _ -> !ip) "[%s@]" Fun.id in
+  let sockaddr = Unix.ADDR_INET (Unix.inet_addr_of_string unwrapped_ip, 0) in
+  let family = Unix.domain_of_sockaddr sockaddr in
+  let sock = Unix.socket family Unix.SOCK_STREAM 0 in
   Unix.setsockopt sock Unix.SO_REUSEADDR true ;
   Unix.bind sock sockaddr ;
   Unix.listen sock 5 ;
