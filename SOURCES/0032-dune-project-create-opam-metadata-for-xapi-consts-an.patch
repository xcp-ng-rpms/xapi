From 109935563ee7b3affbb6523c9ee2684c9914f555 Mon Sep 17 00:00:00 2001
From: Pau Ruiz Safont <pau.safont@vates.tech>
Date: Wed, 16 Jul 2025 13:00:24 +0100
Subject: [PATCH 32/34] dune-project: create opam metadata for xapi-consts and
 xapi-storage-script

Signed-off-by: Pau Ruiz Safont <pau.safont@vates.tech>
---
 dune-project                      | 24 +++++++++++++++++
 xapi-consts.opam                  | 40 +++++++++++++++------------
 xapi-consts.opam.template         | 23 ----------------
 xapi-storage-script.opam          | 45 +++++++++++++++++--------------
 xapi-storage-script.opam.template | 36 -------------------------
 5 files changed, 72 insertions(+), 96 deletions(-)
 delete mode 100644 xapi-consts.opam.template
 delete mode 100644 xapi-storage-script.opam.template

diff --git a/dune-project b/dune-project
index 806b80b18..5195ecbe3 100644
--- a/dune-project
+++ b/dune-project
@@ -139,6 +139,24 @@
 
 (package
   (name xapi-storage-script)
+  (synopsis "The daemon that interacts with SMAPIv3-based SM backends")
+  (description "This daemon watches a directory for subdirectories, and when a subdir is created, a storage service is registered.")
+  (depends
+   (conf-python-3 :with-test)
+   base
+   inotify
+   lwt
+   message-switch-lwt
+   message-switch-unix
+   ppx_deriving_rpc
+   ppx_sexp_conv
+   rpclib
+   rpclib-lwt
+   sexplib0
+   (xapi-idl (= :version))
+   (xapi-stdext-date (= :version))
+   (xapi-storage (= :version))
+  )
 )
 
 (package
@@ -211,6 +229,12 @@
 
 (package
   (name xapi-consts)
+  (synopsis "Data needed across the xapi toolstack")
+  (description "This library contains constants needed across all daemons in the toolstack.")
+  (depends
+   dune-build-info
+   xapi-inventory
+  )
 )
 
 (package
diff --git a/xapi-consts.opam b/xapi-consts.opam
index 2b4726399..b00eedfa8 100644
--- a/xapi-consts.opam
+++ b/xapi-consts.opam
@@ -1,25 +1,31 @@
 # This file is generated by dune, edit dune-project instead
-license: "LGPL-2.1-only WITH OCaml-LGPL-linking-exception"
 opam-version: "2.0"
-maintainer: "xen-api@lists.xen.org"
-authors: [ "xen-api@lists.xen.org" ]
-homepage: "https://github.com/xapi-project/xen-api"
+synopsis: "Data needed across the xapi toolstack"
+description:
+  "This library contains constants needed across all daemons in the toolstack."
+maintainer: ["Xapi project maintainers"]
+authors: ["xen-api@lists.xen.org"]
+license: "LGPL-2.1-only WITH OCaml-LGPL-linking-exception"
+homepage: "https://xapi-project.github.io/"
 bug-reports: "https://github.com/xapi-project/xen-api/issues"
-dev-repo: "git+https://github.com/xapi-project/xen-api.git"
-build: [
-  ["dune" "build" "-p" name "-j" jobs ]
-  ["dune" "runtest" "-p" name "-j" jobs] {with-test}
-]
 depends: [
-  "ocaml"
   "dune" {>= "3.15"}
   "dune-build-info"
   "xapi-inventory"
+  "odoc" {with-doc}
 ]
-synopsis: "The xapi toolstack daemon which implements the XenAPI"
-description: """
-This daemon exposes the XenAPI and is used by clients such as 'xe'
-and 'XenCenter' to manage clusters of Xen-enabled hosts."""
-url {
-  src: "https://github.com/xapi-project/xen-api/archive/master.tar.gz"
-}
+build: [
+  ["dune" "subst"] {dev}
+  [
+    "dune"
+    "build"
+    "-p"
+    name
+    "-j"
+    jobs
+    "@install"
+    "@runtest" {with-test}
+    "@doc" {with-doc}
+  ]
+]
+dev-repo: "git+https://github.com/xapi-project/xen-api.git"
diff --git a/xapi-consts.opam.template b/xapi-consts.opam.template
deleted file mode 100644
index 4d7ad8652..000000000
--- a/xapi-consts.opam.template
+++ /dev/null
@@ -1,23 +0,0 @@
-opam-version: "2.0"
-maintainer: "xen-api@lists.xen.org"
-authors: [ "xen-api@lists.xen.org" ]
-homepage: "https://github.com/xapi-project/xen-api"
-bug-reports: "https://github.com/xapi-project/xen-api/issues"
-dev-repo: "git+https://github.com/xapi-project/xen-api.git"
-build: [
-  ["dune" "build" "-p" name "-j" jobs ]
-  ["dune" "runtest" "-p" name "-j" jobs] {with-test}
-]
-depends: [
-  "ocaml"
-  "dune" {>= "3.15"}
-  "dune-build-info"
-  "xapi-inventory"
-]
-synopsis: "The xapi toolstack daemon which implements the XenAPI"
-description: """
-This daemon exposes the XenAPI and is used by clients such as 'xe'
-and 'XenCenter' to manage clusters of Xen-enabled hosts."""
-url {
-  src: "https://github.com/xapi-project/xen-api/archive/master.tar.gz"
-}
diff --git a/xapi-storage-script.opam b/xapi-storage-script.opam
index 0a974584a..290d421c0 100644
--- a/xapi-storage-script.opam
+++ b/xapi-storage-script.opam
@@ -1,17 +1,14 @@
 # This file is generated by dune, edit dune-project instead
-
 opam-version: "2.0"
-name: "xapi-storage-script"
-maintainer: "xen-api@lists.xen.org"
-authors: [ "xen-api@lists.xen.org" ]
+synopsis: "The daemon that interacts with SMAPIv3-based SM backends"
+description:
+  "This daemon watches a directory for subdirectories, and when a subdir is created, a storage service is registered."
+maintainer: ["Xapi project maintainers"]
+authors: ["xen-api@lists.xen.org"]
 license: "LGPL-2.1-only WITH OCaml-LGPL-linking-exception"
-homepage: "https://github.com/xapi-project/xen-api"
+homepage: "https://xapi-project.github.io/"
 bug-reports: "https://github.com/xapi-project/xen-api/issues"
-dev-repo: "git+https://github.com/xapi-project/xen-api.git"
-tags: [ "org:xapi-project" ]
-build: [[ "dune" "build" "-p" name "-j" jobs ]]
 depends: [
-  "ocaml"
   "dune" {>= "3.15"}
   "conf-python-3" {with-test}
   "base"
@@ -24,15 +21,23 @@ depends: [
   "rpclib"
   "rpclib-lwt"
   "sexplib0"
-  "xapi-idl" {>= "0.10.0"}
-  "xapi-stdext-date"
-  "xapi-storage"
+  "xapi-idl" {= version}
+  "xapi-stdext-date" {= version}
+  "xapi-storage" {= version}
+  "odoc" {with-doc}
 ]
-synopsis: "A directory full of scripts can be a Xapi storage implementation"
-description: """
-This daemon watches a directory for subdirectories, and when a subdir
-is created a storage service is registered."""
-url {
-  src:
-    "https://github.com/xapi-project/xen-api/archive/master.tar.gz"
-}
+build: [
+  ["dune" "subst"] {dev}
+  [
+    "dune"
+    "build"
+    "-p"
+    name
+    "-j"
+    jobs
+    "@install"
+    "@runtest" {with-test}
+    "@doc" {with-doc}
+  ]
+]
+dev-repo: "git+https://github.com/xapi-project/xen-api.git"
diff --git a/xapi-storage-script.opam.template b/xapi-storage-script.opam.template
deleted file mode 100644
index d569fda47..000000000
--- a/xapi-storage-script.opam.template
+++ /dev/null
@@ -1,36 +0,0 @@
-opam-version: "2.0"
-name: "xapi-storage-script"
-maintainer: "xen-api@lists.xen.org"
-authors: [ "xen-api@lists.xen.org" ]
-license: "LGPL-2.1-only WITH OCaml-LGPL-linking-exception"
-homepage: "https://github.com/xapi-project/xen-api"
-bug-reports: "https://github.com/xapi-project/xen-api/issues"
-dev-repo: "git+https://github.com/xapi-project/xen-api.git"
-tags: [ "org:xapi-project" ]
-build: [[ "dune" "build" "-p" name "-j" jobs ]]
-depends: [
-  "ocaml"
-  "dune" {>= "3.15"}
-  "conf-python-3" {with-test}
-  "base"
-  "inotify"
-  "lwt"
-  "message-switch-lwt"
-  "message-switch-unix"
-  "ppx_deriving_rpc"
-  "ppx_sexp_conv"
-  "rpclib"
-  "rpclib-lwt"
-  "sexplib0"
-  "xapi-idl" {>= "0.10.0"}
-  "xapi-stdext-date"
-  "xapi-storage"
-]
-synopsis: "A directory full of scripts can be a Xapi storage implementation"
-description: """
-This daemon watches a directory for subdirectories, and when a subdir
-is created a storage service is registered."""
-url {
-  src:
-    "https://github.com/xapi-project/xen-api/archive/master.tar.gz"
-}
-- 
2.51.0

