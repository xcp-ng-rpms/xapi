From cad0929afec4aa2189274bbc40a578e8175b0242 Mon Sep 17 00:00:00 2001
From: Pau Ruiz Safont <pau.safont@vates.tech>
Date: Sat, 18 Oct 2025 09:21:18 +0100
Subject: [PATCH 6/6] [xcp-ng] do not change rsyslog configuration

Xenserver's changes around rsyslog configuration have downsides and the
packaging prefers the previous behaviour because there's no time to
properly fix the behaviour before the next release.

For the original change, see
https://github.com/xapi-project/xen-api/pull/6328

Discussions on why the original change is dubious:
https://github.com/xcp-ng-rpms/xcp-ng-release/pull/33

Reverts commit 468eb75dddfea6db512a8bfb4860ff2042efab66.

Signed-off-by: Pau Ruiz Safont <pau.safont@vates.tech>
---
 scripts/xe-syslog-reconfigure | 34 +++++++++++++++++++++++++++-------
 1 file changed, 27 insertions(+), 7 deletions(-)

diff --git a/scripts/xe-syslog-reconfigure b/scripts/xe-syslog-reconfigure
index de84881d6..cc64a3030 100644
--- a/scripts/xe-syslog-reconfigure
+++ b/scripts/xe-syslog-reconfigure
@@ -14,12 +14,32 @@ do
   shift
 done
 
-
-if [ $remote -eq 1 ]; then
-  echo "# /etc/rsyslog.d/remote.conf is auto-generated by xe-syslog-reconfigure" > /etc/rsyslog.d/remote.conf
-  echo "*.* @$host" >> /etc/rsyslog.d/remote.conf
-else
-  rm -f /etc/rsyslog.d/remote.conf
+if [ -r /etc/syslog.conf ]; then
+  conf_file=/etc/syslog.conf
+  service=syslog
 fi
 
-systemctl restart rsyslog
+if [ -r /etc/rsyslog.conf ]; then
+  conf_file=/etc/rsyslog.conf
+  service=rsyslog
+fi
+
+if [ -r /etc/rsyslog.d/xenserver.conf ]; then
+  conf_file=/etc/rsyslog.d/xenserver.conf
+  service=rsyslog
+fi
+
+if [ -z "$service" ]; then
+  echo "Error: unable to determine syslog service" >&2
+  exit 1
+fi
+
+sed -e '/^\*\.\*.*[@~]/ d' $conf_file >/etc/syslog.$$
+if [ $remote -eq 1 ]; then
+  echo -e "*.* @$host\n*.* ~" >>/etc/syslog.$$
+else
+  echo "*.* ~" >>/etc/syslog.$$
+fi
+
+[ -s /etc/syslog.$$ ] && mv -f /etc/syslog.$$ $conf_file
+systemctl restart $service
-- 
2.51.0

