From 033c0de4c0f89f8340e7a3ce69353b2ae4e5ac62 Mon Sep 17 00:00:00 2001
From: Gerald Elder-Vass <gerald.elder-vass@cloud.com>
Date: Thu, 27 Feb 2025 15:45:52 +0000
Subject: [PATCH] CA-407370: Use remote.conf for customer rsyslog forwarding
 rules

Signed-off-by: Gerald Elder-Vass <gerald.elder-vass@cloud.com>
---
 scripts/xe-syslog-reconfigure | 28 ++++------------------------
 1 file changed, 4 insertions(+), 24 deletions(-)

diff --git a/scripts/xe-syslog-reconfigure b/scripts/xe-syslog-reconfigure
index cc64a3030..de84881d6 100644
--- a/scripts/xe-syslog-reconfigure
+++ b/scripts/xe-syslog-reconfigure
@@ -14,32 +14,12 @@ do
   shift
 done
 
-if [ -r /etc/syslog.conf ]; then
-  conf_file=/etc/syslog.conf
-  service=syslog
-fi
-
-if [ -r /etc/rsyslog.conf ]; then
-  conf_file=/etc/rsyslog.conf
-  service=rsyslog
-fi
-
-if [ -r /etc/rsyslog.d/xenserver.conf ]; then
-  conf_file=/etc/rsyslog.d/xenserver.conf
-  service=rsyslog
-fi
-
-if [ -z "$service" ]; then
-  echo "Error: unable to determine syslog service" >&2
-  exit 1
-fi
 
-sed -e '/^\*\.\*.*[@~]/ d' $conf_file >/etc/syslog.$$
 if [ $remote -eq 1 ]; then
-  echo -e "*.* @$host\n*.* ~" >>/etc/syslog.$$
+  echo "# /etc/rsyslog.d/remote.conf is auto-generated by xe-syslog-reconfigure" > /etc/rsyslog.d/remote.conf
+  echo "*.* @$host" >> /etc/rsyslog.d/remote.conf
 else
-  echo "*.* ~" >>/etc/syslog.$$
+  rm -f /etc/rsyslog.d/remote.conf
 fi
 
-[ -s /etc/syslog.$$ ] && mv -f /etc/syslog.$$ $conf_file
-systemctl restart $service
+systemctl restart rsyslog
