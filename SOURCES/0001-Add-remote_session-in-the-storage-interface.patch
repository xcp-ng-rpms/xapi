From e19fcb6a2d84e65ec209ccc375cb6e944689eb89 Mon Sep 17 00:00:00 2001
From: Guillaume <guillaume.thouvenin@vates.tech>
Date: Wed, 28 Jan 2026 13:43:02 +0100
Subject: [PATCH] Add remote_session in the storage interface

---
 ocaml/xapi-idl/storage/dune                 |  1 +
 ocaml/xapi-idl/storage/storage_interface.ml | 28 ++++++++++++++--
 ocaml/xapi-idl/storage/storage_skeleton.ml  |  3 +-
 ocaml/xapi-storage-cli/main.ml              |  7 ++++
 ocaml/xapi/session_check.ml                 |  1 +
 ocaml/xapi/storage_migrate.ml               | 12 +++----
 ocaml/xapi/storage_mux.ml                   |  2 +-
 ocaml/xapi/storage_smapiv1.ml               |  2 +-
 ocaml/xapi/storage_smapiv1_migrate.ml       | 36 +++++++++++++++------
 ocaml/xapi/storage_smapiv1_migrate.mli      |  3 ++
 ocaml/xapi/storage_smapiv1_wrapper.ml       |  2 +-
 ocaml/xapi/storage_smapiv3_migrate.ml       |  4 +--
 ocaml/xapi/xapi_vm_migrate.ml               |  9 ++++--
 13 files changed, 82 insertions(+), 28 deletions(-)

diff --git a/ocaml/xapi-idl/storage/dune b/ocaml/xapi-idl/storage/dune
index 0f1a487ff..c024c00ff 100644
--- a/ocaml/xapi-idl/storage/dune
+++ b/ocaml/xapi-idl/storage/dune
@@ -26,6 +26,7 @@
    xapi-idl
    xapi-idl.storage.interface.types
    xapi-log
+   xapi-types
  )
  (wrapped false)
  (preprocess (pps ppx_deriving_rpc ppx_deriving.show)))
diff --git a/ocaml/xapi-idl/storage/storage_interface.ml b/ocaml/xapi-idl/storage/storage_interface.ml
index eaabacc9e..a6c86cc33 100644
--- a/ocaml/xapi-idl/storage/storage_interface.ml
+++ b/ocaml/xapi-idl/storage/storage_interface.ml
@@ -106,6 +106,17 @@ end
 
 type vm = Vm.t
 
+module Ref_session : WRAPPEDSTRING = struct
+  (* This is the domid. *)
+  type t = string [@@deriving rpcty]
+
+  let string_of x = x
+
+  let of_string x = x
+end
+
+type ref_session = Ref_session.t
+
 let vm_pp : Format.formatter -> vm -> unit =
  fun ppf vm -> Format.fprintf ppf "%s" (Vm.string_of vm)
 
@@ -1045,6 +1056,11 @@ module StorageAPI (R : RPC) = struct
         ~description:["when true, verify remote server certificate"]
         Types.bool
 
+    let remote_session_p =
+      Param.mk ~name:"remote_session"
+        ~description:["use it to refresh session during long copy operation"]
+        Ref_session.t
+
     let copy =
       let result_p = Param.mk ~name:"task_id" Task.id in
       declare "DATA.copy" []
@@ -1055,6 +1071,7 @@ module StorageAPI (R : RPC) = struct
         @-> url_p
         @-> dest_p
         @-> verify_dest_p
+        @-> remote_session_p
         @-> returning result_p err
         )
 
@@ -1127,6 +1144,7 @@ module StorageAPI (R : RPC) = struct
         let local_vdi_p = Param.mk ~name:"local_vdi" vdi_info in
         let src_sr_p = Param.mk ~name:"src_sr" Sr.t in
         let dest_sr_p = Param.mk ~name:"dest_sr" Sr.t in
+
         declare "DATA.MIRROR.send_start" []
           (dbg_p
           @-> dp_p
@@ -1142,6 +1160,7 @@ module StorageAPI (R : RPC) = struct
           @-> recv_result_p
           @-> dest_sr_p
           @-> verify_dest_p
+          @-> remote_session_p
           @-> returning unit_p err
           )
 
@@ -1328,6 +1347,7 @@ module type MIRROR = sig
     -> remote_mirror:Mirror.mirror_receive_result
     -> dest_sr:sr
     -> verify_dest:bool
+    -> remote_session:ref_session
     -> unit
 
   val receive_start :
@@ -1649,6 +1669,7 @@ module type Server_impl = sig
       -> url:string
       -> dest:sr
       -> verify_dest:bool
+      -> remote_session:ref_session
       -> Task.id
 
     val mirror :
@@ -1840,8 +1861,8 @@ module Server (Impl : Server_impl) () = struct
         Impl.VDI.list_changed_blocks () ~dbg ~sr ~vdi_from ~vdi_to
     ) ;
     S.get_by_name (fun dbg name -> Impl.get_by_name () ~dbg ~name) ;
-    S.DATA.copy (fun dbg sr vdi vm url dest verify_dest ->
-        Impl.DATA.copy () ~dbg ~sr ~vdi ~vm ~url ~dest ~verify_dest
+    S.DATA.copy (fun dbg sr vdi vm url dest verify_dest remote_session ->
+        Impl.DATA.copy () ~dbg ~sr ~vdi ~vm ~url ~dest ~verify_dest ~remote_session
     ) ;
     S.DATA.mirror (fun dbg sr vdi vm dest ->
         Impl.DATA.mirror () ~dbg ~sr ~vdi ~vm ~dest
@@ -1865,10 +1886,11 @@ module Server (Impl : Server_impl) () = struct
         remote_mirror
         dest_sr
         verify_dest
+        remote_session
       ->
         Impl.DATA.MIRROR.send_start () ~dbg ~task_id ~dp ~sr ~vdi ~mirror_vm
           ~mirror_id ~local_vdi ~copy_vm ~live_vm ~url ~remote_mirror ~dest_sr
-          ~verify_dest
+          ~verify_dest ~remote_session
     ) ;
     S.DATA.MIRROR.receive_start (fun dbg sr vdi_info id similar ->
         Impl.DATA.MIRROR.receive_start () ~dbg ~sr ~vdi_info ~id ~similar
diff --git a/ocaml/xapi-idl/storage/storage_skeleton.ml b/ocaml/xapi-idl/storage/storage_skeleton.ml
index a2d2d04ab..d80570aab 100644
--- a/ocaml/xapi-idl/storage/storage_skeleton.ml
+++ b/ocaml/xapi-idl/storage/storage_skeleton.ml
@@ -199,7 +199,8 @@ module DATA = struct
     type context = unit
 
     let send_start ctx ~dbg ~task_id ~dp ~sr ~vdi ~mirror_vm ~mirror_id
-        ~local_vdi ~copy_vm ~live_vm ~url ~remote_mirror ~dest_sr ~verify_dest =
+        ~local_vdi ~copy_vm ~live_vm ~url ~remote_mirror ~dest_sr ~verify_dest
+        ~remote_session =
       Storage_interface.unimplemented __FUNCTION__
 
     let receive_start ctx ~dbg ~sr ~vdi_info ~id ~similar =
diff --git a/ocaml/xapi-storage-cli/main.ml b/ocaml/xapi-storage-cli/main.ml
index f581d6b6b..74ada4907 100644
--- a/ocaml/xapi-storage-cli/main.ml
+++ b/ocaml/xapi-storage-cli/main.ml
@@ -324,11 +324,18 @@ let mirror_start common_opts sr vdi dp url dest verify_dest =
       let dp = get_opt dp "Need a local data path" in
       let url = get_opt url "Need a URL" in
       let dest = get_opt dest "Need a destination SR" in
+      let dummy_session =
+        "cli_remote_session"
+        |> Ref.make_dummy
+        |> Ref.string_of
+        |> Storage_interface.Ref_session.of_string
+      in
       let task =
         Storage_migrate.start ~dbg ~sr ~vdi ~dp ~mirror_vm ~copy_vm ~live_vm
           ~url
           ~dest:(Storage_interface.Sr.of_string dest)
           ~verify_dest
+          ~remote_session:dummy_session
       in
       Printf.printf "Task id: %s\n" task
     )
diff --git a/ocaml/xapi/session_check.ml b/ocaml/xapi/session_check.ml
index 9e4de98e5..4d98ea99e 100644
--- a/ocaml/xapi/session_check.ml
+++ b/ocaml/xapi/session_check.ml
@@ -77,6 +77,7 @@ let check ~intra_pool_only ~session_id ~action =
                   ptime
             in
             if Ptime.is_later ptime_now ~than:refresh_threshold then
+              debug "GTNDEBUG: set_last_active called for %s" (Ref.string_of session_id) ;
               Db_actions.DB_Action.Session.set_last_active ~__context
                 ~self:session_id ~value:n
         with
diff --git a/ocaml/xapi/storage_migrate.ml b/ocaml/xapi/storage_migrate.ml
index 1ff03c3d7..42fb4d854 100644
--- a/ocaml/xapi/storage_migrate.ml
+++ b/ocaml/xapi/storage_migrate.ml
@@ -126,7 +126,7 @@ module MigrateLocal = struct
         (Storage_error (Migration_preparation_failure (Printexc.to_string e)))
 
   let start ~task_id ~dbg ~sr ~vdi ~dp ~mirror_vm ~copy_vm ~live_vm ~url ~dest
-      ~verify_dest =
+      ~verify_dest ~remote_session =
     SXM.info
       "%s sr:%s vdi:%s dp: %s mirror_vm: %s copy_vm: %s url:%s dest:%s \
        verify_dest:%B"
@@ -173,7 +173,7 @@ module MigrateLocal = struct
       in
       Migrate_Backend.send_start () ~dbg ~task_id ~dp ~sr ~vdi ~mirror_vm
         ~mirror_id ~local_vdi ~copy_vm ~live_vm ~url ~remote_mirror
-        ~dest_sr:dest ~verify_dest ;
+        ~dest_sr:dest ~verify_dest ~remote_session ;
       Some (Mirror_id mirror_id)
     with
     | Storage_error (Sr_not_attached sr_uuid) ->
@@ -421,20 +421,20 @@ let with_task_and_thread ~dbg f =
    this way so that they all stay in one place rather than being spread around the
    file. *)
 
-let copy ~dbg ~sr ~vdi ~vm ~url ~dest ~verify_dest =
+let copy ~dbg ~sr ~vdi ~vm ~url ~dest ~verify_dest ~remote_session =
   with_task_and_thread ~dbg (fun task ->
       Storage_smapiv1_migrate.Copy.copy_into_sr ~task ~dbg:dbg.Debug_info.log
-        ~sr ~vdi ~vm ~url ~dest ~verify_dest
+        ~sr ~vdi ~vm ~url ~dest ~verify_dest ~remote_session
   )
 
-let start ~dbg ~sr ~vdi ~dp ~mirror_vm ~copy_vm ~live_vm ~url ~dest ~verify_dest
+let start ~dbg ~sr ~vdi ~dp ~mirror_vm ~copy_vm ~live_vm ~url ~dest ~verify_dest ~remote_session
     =
   with_dbg ~name:__FUNCTION__ ~dbg @@ fun dbg ->
   with_task_and_thread ~dbg (fun task ->
       MigrateLocal.start
         ~task_id:(Storage_task.id_of_handle task)
         ~dbg:dbg.Debug_info.log ~sr ~vdi ~dp ~mirror_vm ~copy_vm ~live_vm ~url
-        ~dest ~verify_dest
+        ~dest ~verify_dest ~remote_session
   )
 
 (* XXX: PR-1255: copy the xenopsd 'raise Exception' pattern *)
diff --git a/ocaml/xapi/storage_mux.ml b/ocaml/xapi/storage_mux.ml
index 0427f76ca..8f83b9457 100644
--- a/ocaml/xapi/storage_mux.ml
+++ b/ocaml/xapi/storage_mux.ml
@@ -853,7 +853,7 @@ module Mux = struct
 
       let send_start _ctx ~dbg:_ ~task_id:_ ~dp:_ ~sr:_ ~vdi:_ ~mirror_vm:_
           ~mirror_id:_ ~local_vdi:_ ~copy_vm:_ ~live_vm:_ ~url:_
-          ~remote_mirror:_ ~dest_sr:_ ~verify_dest:_ =
+          ~remote_mirror:_ ~dest_sr:_ ~verify_dest:_ ~remote_session:_ =
         Storage_interface.unimplemented
           __FUNCTION__ (* see storage_smapi{v1,v3}_migrate.ml *)
 
diff --git a/ocaml/xapi/storage_smapiv1.ml b/ocaml/xapi/storage_smapiv1.ml
index 0995edc35..d5cfa4d69 100644
--- a/ocaml/xapi/storage_smapiv1.ml
+++ b/ocaml/xapi/storage_smapiv1.ml
@@ -1142,7 +1142,7 @@ module SMAPIv1 : Server_impl = struct
 
       let send_start _ctx ~dbg:_ ~task_id:_ ~dp:_ ~sr:_ ~vdi:_ ~mirror_vm:_
           ~mirror_id:_ ~local_vdi:_ ~copy_vm:_ ~live_vm:_ ~url:_
-          ~remote_mirror:_ ~dest_sr:_ ~verify_dest:_ =
+          ~remote_mirror:_ ~dest_sr:_ ~verify_dest:_ ~remote_session:_ =
         assert false
 
       let receive_start _context ~dbg:_ ~sr:_ ~vdi_info:_ ~id:_ ~similar:_ =
diff --git a/ocaml/xapi/storage_smapiv1_migrate.ml b/ocaml/xapi/storage_smapiv1_migrate.ml
index c850d61f8..c04775160 100644
--- a/ocaml/xapi/storage_smapiv1_migrate.ml
+++ b/ocaml/xapi/storage_smapiv1_migrate.ml
@@ -31,6 +31,8 @@ let s_of_vdi = Storage_interface.Vdi.string_of
 
 let s_of_vm = Storage_interface.Vm.string_of
 
+let s_of_session = Storage_interface.Ref_session.string_of
+
 let with_activated_disk ~dbg ~sr ~vdi ~dp ~vm f =
   let attached_vdi =
     Option.map
@@ -137,7 +139,8 @@ let tapdisk_of_attach_info (backend : Storage_interface.backend) =
         (Storage_interface.(rpc_of backend) backend |> Rpc.to_string) ;
       None
 
-let progress_callback start len t y =
+let progress_callback (refresh_session: unit -> unit) start len t y =
+  refresh_session ();
   let new_progress = start +. (y *. len) in
   Storage_task.set_state t (Task.Pending new_progress) ;
   signal (Storage_task.id_of_handle t)
@@ -152,7 +155,7 @@ let perform_cleanup_actions =
 
 module Copy = struct
   (** [copy_into_vdi] is similar to [copy_into_sr] but requires a [dest_vdi] parameter *)
-  let copy_into_vdi ~task ~dbg ~sr ~vdi ~vm ~url ~dest ~dest_vdi ~verify_dest =
+  let copy_into_vdi ~task ~dbg ~sr ~vdi ~vm ~url ~dest ~dest_vdi ~verify_dest ~remote_session =
     let (module Remote) = get_remote_backend url verify_dest in
     D.debug "copy local=%s/%s url=%s remote=%s/%s verify_dest=%B"
       (Storage_interface.Sr.string_of sr)
@@ -160,7 +163,8 @@ module Copy = struct
       url
       (Storage_interface.Sr.string_of dest)
       (Storage_interface.Vdi.string_of dest_vdi)
-      verify_dest ;
+      verify_dest
+      ;
     (* Check the remote SR exists *)
     let srs = Remote.SR.list dbg in
     if not (List.mem dest srs) then
@@ -257,9 +261,20 @@ module Copy = struct
                   let verify_cert =
                     if verify_dest then Stunnel_client.pool () else None
                   in
+                  let refresh_session =
+                      let url' = Http.Url.of_string url in
+                      let rpc xml =
+                        let transport = Xmlrpc_client.transport_of_url ~verify_cert url' in
+                        let version = "1.1" and path = "/" in
+                        let http = xmlrpc ~version path in
+                        Xmlrpc_client.XMLRPC_protocol.rpc ~transport ~http xml
+                      in
+                      let session_id = Ref.of_secret_string (s_of_session remote_session) in
+                      Xapi_session.consider_touching_session rpc session_id
+                  in
                   let dd =
                     Sparse_dd_wrapper.start
-                      ~progress_cb:(progress_callback 0.05 0.9 task)
+                      ~progress_cb:(progress_callback refresh_session 0.05 0.9 task)
                       ~verify_cert ~proto ?base:base_path true (Option.get src)
                       dest_vdi_url remote_vdi.virtual_size
                   in
@@ -298,7 +313,8 @@ module Copy = struct
   (** [copy_into_sr] does not requires a dest vdi to be provided, instead, it will 
   find the nearest vdi on the [dest] sr, and if there is no such vdi, it will 
   create one. *)
-  let copy_into_sr ~task ~dbg ~sr ~vdi ~vm ~url ~dest ~verify_dest =
+  let copy_into_sr ~task ~dbg ~sr ~vdi ~vm ~url ~dest ~verify_dest
+  ~remote_session =
     D.debug "copy sr:%s vdi:%s url:%s dest:%s verify_dest:%B"
       (Storage_interface.Sr.string_of sr)
       (Storage_interface.Vdi.string_of vdi)
@@ -376,7 +392,7 @@ module Copy = struct
         in
         let remote_copy =
           copy_into_vdi ~task ~dbg ~sr ~vdi ~vm ~url ~dest
-            ~dest_vdi:remote_base.vdi ~verify_dest
+            ~dest_vdi:remote_base.vdi ~verify_dest ~remote_session
           |> vdi_info
         in
         let snapshot = Remote.VDI.snapshot dbg dest remote_copy in
@@ -548,13 +564,13 @@ let mirror_checker mirror_id tapdev =
   inner ()
 
 let mirror_copy ~task ~dbg ~sr ~snapshot ~copy_vm ~url ~dest_sr ~remote_mirror
-    ~verify_dest =
+    ~verify_dest ~remote_session =
   (* Copy the snapshot to the remote *)
   try
     Storage_task.with_subtask task "copy" (fun () ->
         Copy.copy_into_vdi ~task ~dbg ~sr ~vdi:snapshot.vdi ~vm:copy_vm ~url
           ~dest:dest_sr ~dest_vdi:remote_mirror.Mirror.copy_diffs_to
-          ~verify_dest
+          ~verify_dest ~remote_session
     )
     |> vdi_info
   with e ->
@@ -568,7 +584,7 @@ module MIRROR : SMAPIv2_MIRROR = struct
   type context = unit
 
   let send_start _ctx ~dbg ~task_id ~dp ~sr ~vdi ~mirror_vm ~mirror_id
-      ~local_vdi ~copy_vm ~live_vm ~url ~remote_mirror ~dest_sr ~verify_dest =
+      ~local_vdi ~copy_vm ~live_vm ~url ~remote_mirror ~dest_sr ~verify_dest ~remote_session =
     D.debug
       "%s dbg: %s dp: %s sr: %s vdi:%s mirror_vm:%s mirror_id: %s live_vm: %s \
        url:%s dest_sr:%s verify_dest:%B"
@@ -604,7 +620,7 @@ module MIRROR : SMAPIv2_MIRROR = struct
         let task = Storage_task.(handle_of_id tasks) task_id in
         let new_parent =
           mirror_copy ~task ~dbg ~sr ~snapshot ~copy_vm ~url ~dest_sr
-            ~remote_mirror:mirror_res ~verify_dest
+            ~remote_mirror:mirror_res ~verify_dest ~remote_session
         in
 
         D.debug "Local VDI %s = remote VDI %s"
diff --git a/ocaml/xapi/storage_smapiv1_migrate.mli b/ocaml/xapi/storage_smapiv1_migrate.mli
index a1021858e..81df6ee04 100644
--- a/ocaml/xapi/storage_smapiv1_migrate.mli
+++ b/ocaml/xapi/storage_smapiv1_migrate.mli
@@ -36,6 +36,7 @@ module Copy : sig
     -> dest:Storage_interface.sr
     -> dest_vdi:Storage_interface.vdi
     -> verify_dest:bool
+    -> remote_session:Storage_interface.ref_session
     -> Storage_interface.async_result_t option
 
   val copy_into_sr :
@@ -47,6 +48,7 @@ module Copy : sig
     -> url:string
     -> dest:Storage_interface.sr
     -> verify_dest:bool
+    -> remote_session:Storage_interface.ref_session
     -> Storage_interface.async_result_t option
 end
 
@@ -84,6 +86,7 @@ val mirror_copy :
   -> dest_sr:Storage_interface.sr
   -> remote_mirror:Storage_interface.Mirror.mirror_receive_result_vhd_t
   -> verify_dest:bool
+  -> remote_session:Storage_interface.ref_session
   -> Storage_interface.vdi_info
 
 module MIRROR : SMAPIv2_MIRROR
diff --git a/ocaml/xapi/storage_smapiv1_wrapper.ml b/ocaml/xapi/storage_smapiv1_wrapper.ml
index 86879780f..99515fa21 100644
--- a/ocaml/xapi/storage_smapiv1_wrapper.ml
+++ b/ocaml/xapi/storage_smapiv1_wrapper.ml
@@ -1194,7 +1194,7 @@ functor
 
         let send_start _ctx ~dbg:_ ~task_id:_ ~dp:_ ~sr:_ ~vdi:_ ~mirror_vm:_
             ~mirror_id:_ ~local_vdi:_ ~copy_vm:_ ~live_vm:_ ~url:_
-            ~remote_mirror:_ ~dest_sr:_ ~verify_dest:_ =
+            ~remote_mirror:_ ~dest_sr:_ ~verify_dest:_ ~remote_session:_ =
           Storage_interface.unimplemented __FUNCTION__
 
         let receive_start context ~dbg ~sr ~vdi_info ~id ~similar =
diff --git a/ocaml/xapi/storage_smapiv3_migrate.ml b/ocaml/xapi/storage_smapiv3_migrate.ml
index 774239c08..da6598a52 100644
--- a/ocaml/xapi/storage_smapiv3_migrate.ml
+++ b/ocaml/xapi/storage_smapiv3_migrate.ml
@@ -109,14 +109,14 @@ module MIRROR : SMAPIv2_MIRROR = struct
   type context = unit
 
   let send_start _ctx ~dbg ~task_id:_ ~dp ~sr ~vdi ~mirror_vm ~mirror_id
-      ~local_vdi:_ ~copy_vm:_ ~live_vm ~url ~remote_mirror ~dest_sr ~verify_dest
-      =
+      ~local_vdi:_ ~copy_vm:_ ~live_vm ~url ~remote_mirror ~dest_sr ~verify_dest ~remote_session =
     D.debug
       "%s dbg: %s dp: %s sr: %s vdi:%s mirror_vm:%s mirror_id: %s live_vm: %s \
        url:%s dest_sr:%s verify_dest:%B"
       __FUNCTION__ dbg dp (s_of_sr sr) (s_of_vdi vdi) (s_of_vm mirror_vm)
       mirror_id (s_of_vm live_vm) url (s_of_sr dest_sr) verify_dest ;
     ignore (Local.VDI.attach3 dbg dp sr vdi (Vm.of_string "0") true) ;
+    ignore remote_session ;
     (* TODO we are not activating the VDI here because SMAPIv3 does not support
        activating the VDI again on dom 0 when it is already activated on the live_vm.
        This means that if the VM shutsdown while SXM is in progress the
diff --git a/ocaml/xapi/xapi_vm_migrate.ml b/ocaml/xapi/xapi_vm_migrate.ml
index ef7428da0..656b30dbd 100644
--- a/ocaml/xapi/xapi_vm_migrate.ml
+++ b/ocaml/xapi/xapi_vm_migrate.ml
@@ -1019,10 +1019,11 @@ let vdi_copy_fun __context dbg vdi_map remote is_intra_pool remote_vdis so_far
     }
   in
   let mirror_to_remote new_dp =
-    let task =
+    let remote_session: ref_session = Storage_interface.Ref_session.of_string @@ Ref.string_of remote.session in
+    let task: content_id =
       if not vconf.do_mirror then
         SMAPI.DATA.copy dbg vconf.sr vconf.location vconf.copy_vm remote.sm_url
-          dest_sr is_intra_pool
+          dest_sr is_intra_pool remote_session
       else
         (* Though we have no intention of "write", here we use the same mode as the
            associated VBD on a mirrored VDIs (i.e. always RW). This avoids problem
@@ -1053,6 +1054,7 @@ let vdi_copy_fun __context dbg vdi_map remote is_intra_pool remote_vdis so_far
         Storage_migrate.start ~dbg ~sr:vconf.sr ~vdi:vconf.location ~dp:new_dp
           ~mirror_vm:vconf.mirror_vm ~copy_vm:vconf.copy_vm ~live_vm
           ~url:remote.sm_url ~dest:dest_sr ~verify_dest:is_intra_pool
+          ~remote_session
     in
     let mapfn x =
       let total = Int64.to_float total_size in
@@ -1433,7 +1435,8 @@ let migrate_send' ~__context ~vm ~dest ~live:_ ~vdi_map ~vif_map ~vgpu_map
     let so_far = ref 0L in
     let new_vm =
       with_many
-        (vdi_copy_fun __context dbg vdi_map remote is_intra_pool remote_vdis
+        (
+          vdi_copy_fun __context dbg vdi_map remote is_intra_pool remote_vdis
            so_far total_size copy
         )
         all_vdis
